# 개발일지 - Slack 웹훅 알림 기능

**작성 시각**: 2025-12-26

## 해결하고자 한 문제

매일 아침 리포트 생성 완료 시 Slack 채널로 자동 알림을 보내는 기능 구현
- 리포트 생성 완료 알림 자동화
- Block Kit 포맷으로 가독성 좋은 메시지 구성
- 에러 발생 시 재시도 로직 필요

## 해결된 것

✅ **Pydantic 모델 정의** (`models/notification.py`)
- `SlackReportSummary`: 리포트 요약 정보 (total_return, top_stock, highlights 등)
- `SlackNotificationRequest`: Slack 알림 전송 요청 (report_date, summary, report_url)
- `SlackNotificationResponse`: 전송 결과 응답 (success, retry_count, error)

✅ **SlackService 클래스** (`services/slack_service.py`)
- Incoming Webhook 방식 사용
- `SLACK_WEBHOOK_URL` 환경변수로 관리
- Block Kit 포맷 메시지 구성:
  - 헤더: "Daily Report - While You Were Sleeping"
  - 본문: 날짜, 수익률, 화제 종목, 주요 알림 사항
  - 하단: 대시보드 링크 버튼
- 최대 3회 재시도 (2초 간격)
- 성공/실패 로깅

✅ **API 엔드포인트** (`api/notifications.py`)
- `POST /api/notifications/slack`: 리포트 데이터를 받아 Slack으로 전송
- `GET /api/notifications/slack/status`: Webhook 설정 상태 확인

✅ **브리핑 생성 연동** (`api/briefing_generate.py`)
- `_send_slack_notification_for_briefing()` 헬퍼 함수 추가
- AI 브리핑 생성 완료 시 자동으로 Slack 알림 전송
- Slack 알림 실패가 브리핑 생성에 영향을 주지 않도록 예외 처리

✅ **환경변수 설정**
- `.env.example`에 `SLACK_WEBHOOK_URL` 추가
- `.env`에 실제 Webhook URL 설정 완료

✅ **테스트 완료**
- 직접 API 호출 테스트 성공
- AI 브리핑 생성 → Slack 자동 알림 연동 테스트 성공

## 해결되지 않은 것

없음

## 향후 개발을 위한 컨텍스트 정리

### 사용법

```python
from services.slack_service import get_slack_service
from models.notification import SlackReportSummary

slack_service = get_slack_service()

# Webhook 설정 확인
if slack_service.is_configured():
    summary = SlackReportSummary(
        total_return=2.5,
        top_stock="TSLA",
        top_stock_name="Tesla, Inc.",
        top_stock_change=5.23,
        highlights=["Tesla 신형 모델 발표", "거래량 급증"]
    )

    success, retry_count, error = await slack_service.send_notification(
        report_date="2025-12-26",
        summary=summary,
        report_url="http://localhost:3000"
    )
```

### API 호출 예시

```bash
# Slack 알림 전송
curl -X POST http://localhost:8000/api/notifications/slack \
  -H "Content-Type: application/json" \
  -d '{
    "report_date": "2025-12-26",
    "summary": {
      "total_return": 2.5,
      "top_stock": "TSLA",
      "top_stock_name": "Tesla, Inc.",
      "top_stock_change": 5.23,
      "highlights": ["Tesla 신형 모델 발표"]
    },
    "report_url": "http://localhost:3000"
  }'

# 설정 상태 확인
curl http://localhost:8000/api/notifications/slack/status
```

### Slack Webhook 설정 방법

1. https://api.slack.com/apps 에서 앱 생성
2. Incoming Webhooks 활성화
3. 채널 선택 후 Webhook URL 복사
4. `.env` 파일에 추가:
```
SLACK_WEBHOOK_URL=https://hooks.slack.com/services/T.../B.../XXX...
```

### 파일 구조

```
backend/
├── models/notification.py       # Slack 알림 모델
├── services/slack_service.py    # SlackService 클래스
├── api/notifications.py         # 알림 API 라우터
├── api/briefing_generate.py     # 브리핑 생성 (Slack 연동 추가)
├── main.py                      # 라우터 등록
└── .env.example                 # SLACK_WEBHOOK_URL 추가
```

### Block Kit 메시지 구조

```
┌─────────────────────────────────────┐
│  Daily Report - While You Were     │
│  Sleeping                          │
├─────────────────────────────────────┤
│  날짜: 2025-12-26                   │
│  총 수익률: +2.5%                   │
├─────────────────────────────────────┤
│  화제 종목                          │
│  Tesla, Inc. (TSLA) +5.23%         │
├─────────────────────────────────────┤
│  주요 알림                          │
│  • Tesla 신형 모델 발표             │
│  • 거래량 급증                      │
├─────────────────────────────────────┤
│  [대시보드에서 자세히 보기]          │
└─────────────────────────────────────┘
```

### 다음 개선 사항

1. Discord 웹훅 지원 추가
2. 알림 스케줄링 (매일 아침 7시 자동 전송)
3. 알림 히스토리 저장 및 조회
4. 사용자별 알림 설정 관리
