# 개발일지 - 브리핑 생성 MCP 스킬

**작성 시각**: 2025-12-24

## 해결하고자 한 문제

Claude Desktop에서 사용할 수 있는 MCP 스킬을 구현하여, 화제 종목의 최신 뉴스를 수집하고 LLM 모델이 뉴스를 요약하며 종목 그래프를 참고해서 해석한 브리핑을 생성하는 기능을 추가하고자 했습니다.

### 요구사항
1. 화제 종목 선정된 종목들의 최신 뉴스 n개 수집
2. LLM 모델이 뉴스를 요약
3. 종목 그래프를 참고해서 해석
4. 브리핑 내용 작성
5. Claude Desktop에서 MCP 스킬로 사용 가능

## 해결된 것

✅ **MCP 서버 프로젝트 구조 생성**
- `mcp-server/` 디렉토리 생성
- `services/`, `models/` 서브디렉토리 생성
- 기본 파일 구조 구성

✅ **의존성 추가**
- `mcp-server/requirements.txt` 생성
- MCP SDK, Anthropic Claude, yahooquery, exa-py 등 필요한 패키지 추가

✅ **MCP 서버 구현** (`mcp-server/server.py`)
- MCP 서버 초기화 및 stdio transport 설정
- `generate_briefing` 툴 등록
- 종목 선정, 뉴스 수집, 차트 데이터 수집, LLM 호출 통합

✅ **Anthropic Claude 통합 서비스** (`mcp-server/services/llm_service.py`)
- Anthropic Claude API 클라이언트 초기화
- Claude 3.5 Sonnet 모델 사용
- `summarize_news()`: 뉴스 요약 기능
- `analyze_chart()`: 차트 데이터 해석 기능
- `generate_briefing()`: 최종 브리핑 마크다운 생성
- 프롬프트 템플릿 작성 (한국어 지원)

✅ **차트 데이터 수집 서비스** (`mcp-server/services/chart_service.py`)
- Yahoo Finance API를 통한 차트 데이터 수집
- 최근 5일 데이터 수집
- LLM이 이해하기 쉬운 텍스트 형식으로 변환
  - 날짜별 가격 변동
  - 최고가/최저가
  - 거래량 추이
  - 변동률 요약

✅ **기존 서비스 통합**
- `screener_service.py`: 화제 종목 선정 재사용
- `news_service.py`: 뉴스 수집 재사용
- 백엔드 모델 및 유틸리티 재사용

✅ **환경 변수 설정**
- `.env.example` 파일 생성 (차단되어 직접 생성 불가, README에 문서화)
- 프로젝트 루트와 mcp-server 디렉토리 모두에서 .env 파일 로드 지원

✅ **클로드 데스크톱 설정 업데이트**
- `2주차 과제/claude_desktop_config.json`에 MCP 서버 추가
- stdio transport 설정
- 환경 변수 전달 설정

✅ **문서화**
- `mcp-server/README.md` 작성
  - 설치 방법
  - 사용법
  - 아키텍처 설명
  - 문제 해결 가이드

## 해결되지 않은 것 / 향후 개선 필요

⚠️ **환경 변수 파일**
- `.env.example` 파일이 globalignore에 의해 차단되어 직접 생성 불가
- 사용자가 수동으로 환경 변수를 설정해야 함

⚠️ **테스트**
- MCP 서버 실행 테스트 미완료
- Claude Desktop에서 실제 스킬 호출 테스트 미완료
- 에러 핸들링 추가 테스트 필요

⚠️ **기능 개선**
- 차트 기간 선택 옵션 추가 (현재는 5일 고정)
- 브리핑 생성 시 점수 정보 활용 개선
- 캐싱 기능 추가 고려

## 기술적 세부사항

### 아키텍처

```
Claude Desktop
    ↓ MCP Protocol (stdio)
MCP Server (server.py)
    ↓ 호출
├── Hot Stock Screener (화제 종목 선정)
├── News Service (뉴스 수집, Exa API)
├── Chart Service (차트 데이터 수집, Yahoo Finance)
└── LLM Service (Anthropic Claude API)
    ├── summarize_news() - 뉴스 요약
    ├── analyze_chart() - 차트 해석
    └── generate_briefing() - 브리핑 생성
    ↓
브리핑 마크다운 콘텐츠 반환
```

### 주요 구현 파일

1. **`mcp-server/server.py`**
   - MCP 서버 메인 파일
   - stdio transport 사용
   - `generate_briefing` 툴 구현
   - 백엔드 서비스 경로 추가하여 기존 서비스 재사용

2. **`mcp-server/services/llm_service.py`**
   - Anthropic Claude API 클라이언트
   - Claude 3.5 Sonnet 모델 사용
   - 프롬프트 템플릿 관리
   - 뉴스 요약, 차트 분석, 브리핑 생성 함수

3. **`mcp-server/services/chart_service.py`**
   - Yahoo Finance 차트 데이터 수집
   - 텍스트 형식 변환 (LLM 입력용)
   - 가격 변동, 거래량 추이 등 요약 정보 생성

### 환경 변수

```env
ANTHROPIC_API_KEY=your_anthropic_api_key_here
EXA_API_KEY=your_exa_api_key_here
```

### 사용 예시

Claude Desktop에서:
```
@generate_briefing ticker="TSLA" news_count=3
```

또는:
```
@generate_briefing  # 자동으로 화제 종목 선정
```

## 향후 개발을 위한 컨텍스트

### MCP 서버 실행 방법

1. 의존성 설치:
```bash
cd mcp-server
pip install -r requirements.txt
```

2. 환경 변수 설정:
- 프로젝트 루트의 `.env` 파일에 `ANTHROPIC_API_KEY`와 `EXA_API_KEY` 추가
- 또는 `mcp-server/.env` 파일 생성

3. Claude Desktop 설정:
- `2주차 과제/claude_desktop_config.json`에 MCP 서버 추가 (이미 완료)
- 절대 경로 사용: `/Users/larkkim/while-you-were-sleeping-dashboard/mcp-server/server.py`

### 백엔드 서비스 재사용

MCP 서버는 백엔드의 기존 서비스를 재사용합니다:
- `backend/services/screener_service.py`: 화제 종목 선정
- `backend/services/news_service.py`: 뉴스 수집
- `backend/models/`: Pydantic 모델

이를 위해 `sys.path`에 백엔드 경로를 추가하여 Python 모듈 임포트가 가능하도록 했습니다.

### LLM 모델 선택

현재는 `claude-3-5-sonnet-20241022` (Claude 3.5 Sonnet)를 기본 모델로 사용합니다. 고품질의 분석과 요약을 제공합니다. 필요시 `llm_service.py`에서 모델을 변경할 수 있습니다.

### 에러 핸들링

각 단계에서 발생할 수 있는 에러를 처리합니다:
- 종목을 찾을 수 없는 경우
- 뉴스 수집 실패
- 차트 데이터 수집 실패
- LLM API 호출 실패

에러 발생 시 사용자에게 명확한 메시지를 제공합니다.

### 확장 가능성

- 추가 툴 구현 가능 (예: 종목 비교, 브리핑 히스토리 조회)
- 다른 LLM 제공자 지원 (예: OpenAI GPT, 다른 Claude 모델)
- 캐싱 레이어 추가로 성능 개선
- 비동기 처리 최적화

### 변경 사항 (2025-12-24)

- LLM 모델을 OpenAI GPT에서 Anthropic Claude로 변경
- 환경 변수명 변경: `OPENAI_API_KEY` → `ANTHROPIC_API_KEY`
- Claude 3.5 Sonnet 모델 사용

