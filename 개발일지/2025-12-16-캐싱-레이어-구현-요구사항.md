# 개발일지 - 캐싱 레이어 구현 요구사항 작성

**작성 시각**: 2025-12-16

## 해결하고자 한 문제

- **API 응답 속도 개선**: 외부 API 호출로 인한 느린 응답 시간 문제 (Yahoo Finance, Exa 뉴스 등)
- **서버 부하 감소**: 동일한 요청에 대한 중복 처리를 방지하여 리소스 절약
- **확장성 확보**: 분산 환경에서도 동일한 캐시를 공유할 수 있는 구조 필요
- **현재 상태 파악**: 이미 인메모리 캐시가 구현되어 있으나, Redis 지원 및 개선 사항이 필요

## 해결된 것

✅ **구조화된 요구사항 문서 작성**
- 기능명, 목적, 사용 시나리오 명확히 정의
- 엔드포인트, Request/Response 형식 상세히 작성
- 기술적 고려사항 (에러 처리, 유효성 검증, 성능 최적화) 체계적으로 정리

✅ **레이어드 캐싱 전략 설계**
- L1: 인메모리 캐시 (빠른 접근)
- L2: Redis 캐시 (분산 환경 지원)
- 폴백 전략 포함

✅ **캐시 관리 API 설계**
- 캐시 초기화, 특정 키 삭제, 통계 조회 엔드포인트 정의
- 캐시 무효화 전략 (자동 만료, 수동 삭제, 태그 기반, 이벤트 기반)

✅ **TTL 전략 수립**
- 데이터 타입별 최적 TTL 설정
- 실시간성 요구사항에 따른 차등 적용

✅ **성능 최적화 방안 제시**
- Redis 최적화 (Connection Pooling, 파이프라인, 압축)
- 메모리 캐시 최적화 (LRU Eviction, 크기 제한)
- 캐시 워밍업 전략
- 모니터링 메트릭 정의

## 해결되지 않은 것 / 향후 개선 필요

⚠️ **실제 구현 필요**
- Redis 클라이언트 라이브러리 통합 (redis-py 또는 aioredis)
- 레이어드 캐시 서비스 구현
- 캐시 관리 API 엔드포인트 구현
- 폴백 로직 구현

⚠️ **캐시 무효화 전략 세부 구현**
- 태그 기반 캐시 무효화 로직
- 이벤트 기반 무효화 메커니즘
- Cache Stampede 방지를 위한 분산 락 구현

⚠️ **모니터링 시스템 연동**
- 캐시 메트릭 수집 및 시각화
- 알림 설정 (히트율 저하, 메모리 사용량 초과 등)

⚠️ **테스트 코드 작성**
- 캐시 동작 테스트
- 폴백 로직 테스트
- 성능 테스트 (히트율 측정, 응답 시간 비교)

⚠️ **문서화 보완**
- Redis 설정 가이드
- 환경 변수 설정 가이드
- 운영 가이드 (캐시 관리, 트러블슈팅)

## 기술적 세부사항

### 현재 구조
- `backend/services/cache_service.py`: 간단한 인메모리 캐시 구현
- `backend/api/stock.py`: 캐시 사용 중인 API들
- 기본 TTL 설정: 300초(5분) ~ 900초(15분)

### 설계한 구조
- **레이어드 캐싱**: L1(메모리) + L2(Redis)
- **캐시 키 전략**: `{service}:{resource}:{identifier}:{params}` 형식
- **환경별 설정**: 개발 환경은 메모리 캐시, 프로덕션은 Redis 우선
- **에러 처리**: Redis 실패 시 메모리 캐시로 자동 폴백

### 주요 기술 스택 제안
- **Redis 클라이언트**: `redis` 또는 `aioredis` (비동기 지원)
- **직렬화**: Pydantic 모델을 JSON으로 변환
- **압축**: 큰 데이터는 gzip 압축 (선택적)

### 성능 목표
- **히트율**: 70% 이상
- **응답 시간 개선**: 캐시 히트 시 90% 이상 단축 (2-3초 → 50-100ms)
- **메모리 사용량**: 적절한 크기 제한 및 LRU Eviction

## 향후 개발을 위한 컨텍스트

### 구현 우선순위
1. **Phase 1**: Redis 클라이언트 통합 및 기본 캐시 서비스 확장
2. **Phase 2**: 레이어드 캐싱 로직 구현
3. **Phase 3**: 캐시 관리 API 엔드포인트 추가
4. **Phase 4**: 모니터링 및 메트릭 수집
5. **Phase 5**: 고급 기능 (캐시 워밍업, 분산 락, 압축 등)

### 환경 변수 설정 필요
```env
# Redis 설정 (선택적)
REDIS_ENABLED=true
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=0
REDIS_MAX_CONNECTIONS=50

# 메모리 캐시 설정
MEMORY_CACHE_MAX_SIZE=1000
MEMORY_CACHE_TTL_DEFAULT=300
```

### 기존 코드와의 통합
- `backend/services/cache_service.py`를 확장하여 Redis 지원 추가
- 기존 `cache` 싱글톤 인스턴스 유지 (하위 호환성)
- 점진적 마이그레이션 가능하도록 설계

### 주의사항
- **데이터 일관성**: 캐시와 실제 데이터 간 일관성 유지 필요
- **캐시 키 네이밍**: 네임스페이스 충돌 방지
- **메모리 관리**: 무제한 캐시 증가 방지
- **보안**: Redis 인증 및 네트워크 보안 고려

### 참고 자료
- 작성된 요구사항 문서: `캐싱-레이어-구현-요구사항.md`
- 기존 캐시 서비스: `backend/services/cache_service.py`
- API 명세서: `API 명세서.md`

